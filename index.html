<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Sports Streams</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary': '#0b0f13',
            'secondary': '#10b981',
          },
        },
      },
    };
  </script>

  <style>
    body {
      background-color: #ffffff;
      color: #333333;
      font-family: system-ui, sans-serif;
    }
    a.footer-link {
      float: right;
      font-size: 10px;
      color: #6b6b6b;
      text-decoration: none;
    }
  </style>
</head>
<body class="w-full min-h-screen bg-white text-gray-800 p-6">

  <div class="w-full mx-auto px-6">
    <div id="root" class="text-center py-10 text-gray-600">Loading streams...</div>
  </div>

  <a class="footer-link" href="https://streamcenter.live" target="_blank">Live Stream Sports</a>

  <script>
    (function() {
      const API_URL = 'https://backendstreamcenter.youshop.pro:488/api';
      const CATEGORY_ID = 'all';

      let allGames = [];
      let categories = [];
      let currentCategoryId = CATEGORY_ID;
      let expandedGame = null;
      let streamsCache = {};

      const formatDateTime = (dateString) => {
        try {
          const d = new Date(dateString);
          if (isNaN(d.getTime())) return dateString || '';
          const date = d.toLocaleDateString();
          const time = d.toLocaleTimeString([], {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          return `${date} â€¢ ${time}`;
        } catch (e) {
          return dateString || '';
        }
      };

      async function loadData() {
        try {
          const [catsRes, gamesRes] = await Promise.all([
            fetch(API_URL + '/Categories'),
            fetch(API_URL + '/Parties?pageNumber=1&pageSize=500'),
          ]);

          const cats = catsRes.ok ? await catsRes.json() : [];
          const rawGames = gamesRes.ok ? await gamesRes.json() : [];

          categories = Array.isArray(cats) ? cats : [];
          const enriched = (Array.isArray(rawGames) ? rawGames : []).map(g => {
            const fullCat = cats && Array.isArray(cats) ? cats.find(c => c.id === g.categoryId) : null;
            return { ...g, category: fullCat || g.category };
          });

          const formatted = enriched.map(g => ({
            ...g,
            parsedDate: new Date(g.beginPartie || g.date || Date.now()),
            title: (g.name || '').replace(/\s+\|\s+/g, ' vs ')
          }));

          formatted.sort((a, b) => new Date(a.parsedDate) - new Date(b.parsedDate));
          allGames = formatted;

          renderWidget();
        } catch (error) {
          console.error('Widget error:', error);
          document.getElementById('root').innerHTML =
            '<div class="text-left py-8 text-red-400">Failed to load streams</div>';
        }
      }

      async function fetchStreamsForGame(game) {
        if (!game) return [];
        if (streamsCache[game.id]) return streamsCache[game.id];

        if (game.videoUrl && typeof game.videoUrl === 'string') {
          try {
            const parts = game.videoUrl.split(';').map(p => p.trim()).filter(Boolean);
            const parsed = parts.map(p => {
              const [url, label] = p.split('<');
              return { url: url?.trim(), name: (label || 'Stream').trim() };
            }).filter(s => s.url);
            if (parsed.length > 0) {
              streamsCache[game.id] = parsed;
              return parsed;
            }
          } catch {}
        }

        if (Array.isArray(game.streams) && game.streams.length > 0) {
          streamsCache[game.id] = game.streams;
          return game.streams;
        }
        if (Array.isArray(game.servers) && game.servers.length > 0) {
          streamsCache[game.id] = game.servers;
          return game.servers;
        }

        try {
          const res = await fetch(API_URL + '/Parties/' + game.id + '/Servers');
          if (res.ok) {
            const data = await res.json();
            const arr = Array.isArray(data) ? data : [];
            streamsCache[game.id] = arr;
            return arr;
          }
        } catch {}
        streamsCache[game.id] = [];
        return [];
      }

      async function toggleExpand(game) {
        if (expandedGame && expandedGame.id === game.id) {
          expandedGame = null;
          renderWidget();
          return;
        }
        await fetchStreamsForGame(game);
        expandedGame = game;
        renderWidget();
      }

      function renderWidget() {
        const container = document.getElementById('root');
        container.innerHTML = '';

        // Category Tabs
        const categorySection = document.createElement('div');
        categorySection.className = 'mb-6 overflow-x-auto';

        const categoryTabs = document.createElement('div');
        categoryTabs.className = 'flex space-x-3 items-center';

        const categoriesWithAll = [{ id: 'all', name: 'All', imagePath: null }, ...categories];

        categoriesWithAll.forEach(cat => {
          const button = document.createElement('button');
           button.className = `flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap border ${
             cat.id === currentCategoryId
               ? 'bg-secondary text-white border-secondary'
               : 'bg-gray-100 border-gray-300 text-gray-700 hover:bg-gray-200'
           }`;

          const span = document.createElement('span');
          span.className = 'text-sm';
          span.textContent = cat.name;
          button.appendChild(span);

          button.onclick = () => {
            currentCategoryId = cat.id;
            renderWidget();
          };

          categoryTabs.appendChild(button);
        });

        categorySection.appendChild(categoryTabs);
        container.appendChild(categorySection);

        // Games List
        const gamesContainer = document.createElement('div');
        gamesContainer.className = 'grid grid-cols-1 gap-4';

        const filteredGames =
          currentCategoryId === 'all'
            ? allGames
            : allGames.filter(
                g =>
                  String(g.categoryId) === String(currentCategoryId) ||
                  (g.category && String(g.category.id) === String(currentCategoryId))
              );

         if (filteredGames.length === 0) {
           gamesContainer.innerHTML =
             '<div class="text-left py-8 text-gray-600">No games found in this category.</div>';
        } else {
          filteredGames.forEach(game => {
            const gameDiv = document.createElement('div');
            gameDiv.className =
              'bg-white rounded-xl p-4 border border-gray-200 cursor-pointer hover:shadow-xl transition-shadow duration-200 shadow-sm';
            gameDiv.onclick = () => toggleExpand(game);

            const header = document.createElement('div');
            header.className = 'flex items-center justify-between';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-left flex-1';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'font-semibold text-lg mb-1';
            titleDiv.textContent = game.title || game.name || 'Match';

            const catDiv = document.createElement('div');
            catDiv.className = 'text-xs text-gray-500';
            catDiv.textContent = (game.category && game.category.name) || 'General';

            infoDiv.appendChild(titleDiv);
            infoDiv.appendChild(catDiv);
            header.appendChild(infoDiv);
            gameDiv.appendChild(header);

            // Expanded Section
             if (expandedGame && expandedGame.id === game.id) {
               const expandedDiv = document.createElement('div');
               expandedDiv.className =
                 'mt-4 border-t border-gray-200 pt-4 bg-gray-50 rounded-b-xl transition-all';

              const servers = streamsCache[game.id] || [];

               if (servers.length > 0) {
                 servers.forEach((s, i) => {
                   const serverContainer = document.createElement('div');
                   serverContainer.className = 'flex items-center justify-between mb-2 p-3 rounded bg-white hover:bg-gray-100 border border-gray-200';
                   
                   const serverButton = document.createElement('button');
                   serverButton.className = 'flex-1 text-left';
                   serverButton.textContent = `Server ${i + 1}`;
                   serverButton.onclick = e => {
                     e.stopPropagation();
                     window.open(s.url || s.stream || s, '_blank');
                   };
                   
                   const buttonContainer = document.createElement('div');
                   buttonContainer.className = 'flex gap-2 ml-3';

                   const copyTitleButton = document.createElement('button');
                   copyTitleButton.className = 'px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors';
                   copyTitleButton.textContent = 'Copy Title';
                   copyTitleButton.onclick = e => {
                     e.stopPropagation();
                     const titleText = game.title || game.name || 'Match';
                     navigator.clipboard.writeText(titleText).then(() => {
                       copyTitleButton.textContent = 'Copied!';
                       setTimeout(() => {
                         copyTitleButton.textContent = 'Copy Title';
                       }, 2000);
                     }).catch(() => {
                       // Fallback for older browsers
                       const textArea = document.createElement('textarea');
                       textArea.value = titleText;
                       document.body.appendChild(textArea);
                       textArea.select();
                       document.execCommand('copy');
                       document.body.removeChild(textArea);
                       copyTitleButton.textContent = 'Copied!';
                       setTimeout(() => {
                         copyTitleButton.textContent = 'Copy Title';
                       }, 2000);
                     });
                   };

                   const copyIframeButton = document.createElement('button');
                   copyIframeButton.className = 'px-3 py-2 text-sm bg-secondary text-white rounded hover:bg-green-600 transition-colors';
                   copyIframeButton.textContent = 'Copy Iframe';
                   copyIframeButton.onclick = e => {
                     e.stopPropagation();
                     const iframeCode = `<iframe src="${s.url || s.stream || s}" width="100%" height="400" frameborder="0" allowfullscreen></iframe>`;
                     navigator.clipboard.writeText(iframeCode).then(() => {
                       copyIframeButton.textContent = 'Copied!';
                       setTimeout(() => {
                         copyIframeButton.textContent = 'Copy Iframe';
                       }, 2000);
                     }).catch(() => {
                       // Fallback for older browsers
                       const textArea = document.createElement('textarea');
                       textArea.value = iframeCode;
                       document.body.appendChild(textArea);
                       textArea.select();
                       document.execCommand('copy');
                       document.body.removeChild(textArea);
                       copyIframeButton.textContent = 'Copied!';
                       setTimeout(() => {
                         copyIframeButton.textContent = 'Copy Iframe';
                       }, 2000);
                     });
                   };

                   buttonContainer.appendChild(copyTitleButton);
                   buttonContainer.appendChild(copyIframeButton);
                   
                   serverContainer.appendChild(serverButton);
                   serverContainer.appendChild(buttonContainer);
                   expandedDiv.appendChild(serverContainer);
                 });
               } else {
                const noStream = document.createElement('div');
                noStream.className = 'text-sm text-gray-600';
                noStream.textContent = 'No servers found for this game.';
                expandedDiv.appendChild(noStream);
              }

              gameDiv.appendChild(expandedDiv);
            }

            gamesContainer.appendChild(gameDiv);
          });
        }

        container.appendChild(gamesContainer);
      }

      loadData();
    })();
  </script>
</body>
</html>
